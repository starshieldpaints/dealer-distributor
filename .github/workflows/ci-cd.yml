name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: ddms-prod-eks
  HELM_RELEASE_NAME: ddms

jobs:
  lint-test:
    name: Lint & Test (${{ matrix.component }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [backend, frontend]
    defaults:
      run:
        working-directory: ${{ matrix.component }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ matrix.component }}/package-lock.json
      - run: npm ci
      - run: npm run lint
      - if: matrix.component == 'backend'
        run: npm run test -- --runInBand

  docker-build-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    needs: lint-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
    env:
      BACKEND_IMAGE: ${{ secrets.ECR_BACKEND_REPO }}
      FRONTEND_IMAGE: ${{ secrets.ECR_FRONTEND_REPO }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
      - id: meta
        run: echo "image_tag=${GITHUB_SHA}" >> "$GITHUB_OUTPUT"
      - name: Build backend
        run: |
          docker build -t ${BACKEND_IMAGE}:${{ steps.meta.outputs.image_tag }} -f backend/Dockerfile backend
      - name: Build frontend
        env:
          API_FQDN: ${{ secrets.API_FQDN }}
        run: |
          docker build \
            --build-arg VITE_API_BASE_URL=https://${API_FQDN} \
            -t ${FRONTEND_IMAGE}:${{ steps.meta.outputs.image_tag }} \
            -f frontend/Dockerfile frontend
      - name: Push backend image
        run: docker push ${BACKEND_IMAGE}:${{ steps.meta.outputs.image_tag }}
      - name: Push frontend image
        run: docker push ${FRONTEND_IMAGE}:${{ steps.meta.outputs.image_tag }}

  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest
    needs: lint-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: infrastructure/terraform
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: terraform fmt -check
      - run: terraform init -upgrade
      - run: terraform validate
      - name: Terraform plan
        run: terraform plan -out=tfplan
      - name: Terraform apply
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve tfplan

  deploy:
    name: Deploy via Helm
    runs-on: ubuntu-latest
    needs:
      - docker-build-push
      - terraform
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
    env:
      BACKEND_IMAGE: ${{ secrets.ECR_BACKEND_REPO }}
      FRONTEND_IMAGE: ${{ secrets.ECR_FRONTEND_REPO }}
      FRONTEND_FQDN: ${{ secrets.FRONTEND_FQDN }}
      API_FQDN: ${{ secrets.API_FQDN }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Write Helm values from secrets
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
          REDIS_URL: ${{ secrets.REDIS_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          ALLOWED_ORIGINS: ${{ secrets.ALLOWED_ORIGINS }}
          IMAGE_TAG: ${{ needs.docker-build-push.outputs.image_tag }}
        run: |
          cat <<EOF > ci-values.yaml
ingress:
  frontendHost: ${FRONTEND_FQDN}
  apiHost: ${API_FQDN}
backend:
  image:
    repository: ${BACKEND_IMAGE}
    tag: ${IMAGE_TAG}
  env:
    allowedOrigins:
      - ${ALLOWED_ORIGINS}
  secrets:
    postgresUrl: ${POSTGRES_URL}
    redisUrl: ${REDIS_URL}
    jwtSecret: ${JWT_SECRET}
frontend:
  image:
    repository: ${FRONTEND_IMAGE}
    tag: ${IMAGE_TAG}
EOF
      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name ${EKS_CLUSTER_NAME} --region ${AWS_REGION}
      - name: Helm upgrade
        run: |
          helm upgrade --install ${HELM_RELEASE_NAME} infrastructure/helm/ddms \
            --namespace default \
            --create-namespace \
            -f infrastructure/helm/ddms/values.yaml \
            -f ci-values.yaml
